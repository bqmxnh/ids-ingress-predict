<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Network Traffic Analysis Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    .attack { color: #ef4444; font-weight: 600; }
    .normal { color: #22c55e; font-weight: 600; }

    .new-flow td { animation: slideIn 0.4s ease-out; }

    .flash-feedback {
      animation: flashYellow 1.5s ease-out;
    }
    .flash-learn {
      animation: flashRed 1.5s ease-out;
    }

    @keyframes flashYellow {
      0% { background-color: #fff9c2; }
      100% { background-color: transparent; }
    }
    @keyframes flashRed {
      0% { background-color: #ffd1d1; }
      100% { background-color: transparent; }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">

    <!-- Header -->
    <header class="mb-6 text-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600 dark:text-indigo-400">
        Network Traffic Analysis Dashboard
      </h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        Real-time monitoring and analysis of network flows
      </p>
    </header>

    <!-- Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-6">
      <canvas id="flowChart" class="w-full h-64"></canvas>
    </div>

    <!-- Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 overflow-x-auto">
      <table id="flowTable" class="w-full border-collapse">
        <thead>
          <tr class="bg-indigo-600 text-white text-sm uppercase">
            <th class="p-3 text-left">Flow ID</th>
            <th class="p-3 text-left">Source IP</th>
            <th class="p-3 text-left">Source Port</th>
            <th class="p-3 text-left">Destination IP</th>
            <th class="p-3 text-left">Destination Port</th>
            <th class="p-3 text-left">Protocol</th>
            <th class="p-3 text-left">Prediction</th>
            <th class="p-3 text-left">Confidence</th>
            <th class="p-3 text-left">Timestamp</th>
          </tr>
        </thead>
        <tbody id="flowBody"></tbody>
      </table>
    </div>

    <!-- Footer -->
    <footer class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">
      <p>Authors: MinhBQ - QuanTC</p>
      <p>Course: Graduation Thesis - 2025</p>
      <p>Last updated: October 2025</p>
    </footer>
  </div>

  <!-- Popup -->
  <div id="popup"
       class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-11/12 md:w-1/2 shadow-xl">
      <h2 class="text-lg font-semibold mb-2">Flow Details</h2>
      <pre id="popupContent"
           class="text-sm bg-gray-100 dark:bg-gray-700 p-3 rounded-lg overflow-auto max-h-96"></pre>

      <button onclick="closePopup()"
              class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
        Close
      </button>
    </div>
  </div>

  <script>
    const socket = io({
      transports: ["websocket", "polling"],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 2000
    });

    const tbody = document.getElementById("flowBody");
    let flows = [];
    const maxFlows = 500;

    // Chart Setup
    const ctx = document.getElementById("flowChart").getContext("2d");
    const chartData = { labels: [], attackCounts: [], benignCounts: [] };
    const flowChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: chartData.labels,
        datasets: [
          { label: "ATTACK", data: chartData.attackCounts,
            borderColor: "#ef4444", backgroundColor: "rgba(239,68,68,0.2)", fill: true, tension: 0.4 },
          { label: "BENIGN", data: chartData.benignCounts,
            borderColor: "#22c55e", backgroundColor: "rgba(34,197,94,0.2)", fill: true, tension: 0.4 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, animation: false }
    });

    function updateChart(flow) {
      const now = new Date();
      const t = now.toLocaleTimeString();
      if (chartData.labels[chartData.labels.length - 1] !== t) {
        chartData.labels.push(t);
        chartData.attackCounts.push(0);
        chartData.benignCounts.push(0);
        if (chartData.labels.length > 20) {
          chartData.labels.shift();
          chartData.attackCounts.shift();
          chartData.benignCounts.shift();
        }
      }
      const idx = chartData.labels.length - 1;
      if (flow.binary_prediction === "attack") chartData.attackCounts[idx]++;
      else chartData.benignCounts[idx]++;
      flowChart.update("none");
    }

    // Render table
    function renderTable() {
      tbody.innerHTML = flows.map(f => `
        <tr class="hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors new-flow ${f.flash_class || ""}"
            onclick='showPopup(${JSON.stringify(f)})'>
          <td class="p-3 text-sm">${f.flow_id}</td>
          <td class="p-3 text-sm">${f.src_ip}</td>
          <td class="p-3 text-sm">${f.src_port}</td>
          <td class="p-3 text-sm">${f.dst_ip}</td>
          <td class="p-3 text-sm">${f.dst_port}</td>
          <td class="p-3 text-sm">${f.protocol}</td>
          <td class="p-3 text-sm ${f.binary_prediction === "attack" ? "attack" : "normal"}">
            ${f.binary_prediction.toUpperCase()}
          </td>
          <td class="p-3 text-sm">${f.binary_confidence?.toFixed(4) || "N/A"}</td>
          <td class="p-3 text-sm">${f.timestamp}</td>
        </tr>
      `).join("");
    }

    // ==== Receive prediction ====
    socket.on("new_flow", (flow) => {
      flow.flash_class = "";
      flows.unshift(flow);
      if (flows.length > maxFlows) flows.pop();
      updateChart(flow);
      renderTable();
    });

    // ==== Highlight feedback ====
    socket.on("feedback_event", (fb) => {
      const idx = flows.findIndex(f => f.flow_id === fb.flow_id);
      if (idx !== -1) {
        flows[idx].flash_class = "flash-feedback";
        renderTable();
      }
    });

    // ==== Highlight learned ====
    socket.on("learn_event", (report) => {
      const idx = flows.findIndex(f => f.flow_id === report.flow_id);
      if (idx !== -1) {
        flows[idx].flash_class = "flash-learn";
        renderTable();
      }
    });

    // Popup
    function showPopup(flow) {
      document.getElementById("popupContent").textContent =
        JSON.stringify(flow, null, 2);
      document.getElementById("popup").classList.remove("hidden");
    }
    function closePopup() {
      document.getElementById("popup").classList.add("hidden");
    }

  </script>
</body>
</html>
